<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>基于阿里云的智能温度计 | 不听话的兔子君</title><meta name="keywords" content="阿里云,MQTT协议"><meta name="author" content="naughtyrabbit"><meta name="copyright" content="naughtyrabbit"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文详尽地描述了一个基于阿里云的智能温度计项目，功能是上报温度数据到阿里云的物联网平台，所有的代码都是“物联网零妖”这位大佬的，我改了一部分，此文旨在加以解释。如果觉得我说的不好，可以看他的原视频：https:&#x2F;&#x2F;edu.aliyun.com&#x2F;course&#x2F;1492?spm&#x3D;5176.10731491.0.0.ZXRrm4">
<meta property="og:type" content="article">
<meta property="og:title" content="基于阿里云的智能温度计">
<meta property="og:url" content="https://naughtyrabbit.github.io/2021/08/27/AliIot_postTem/index.html">
<meta property="og:site_name" content="不听话的兔子君">
<meta property="og:description" content="本文详尽地描述了一个基于阿里云的智能温度计项目，功能是上报温度数据到阿里云的物联网平台，所有的代码都是“物联网零妖”这位大佬的，我改了一部分，此文旨在加以解释。如果觉得我说的不好，可以看他的原视频：https:&#x2F;&#x2F;edu.aliyun.com&#x2F;course&#x2F;1492?spm&#x3D;5176.10731491.0.0.ZXRrm4">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://m1.im5i.com/2022/08/19/UcP6AG.jpg">
<meta property="article:published_time" content="2021-08-27T12:06:46.000Z">
<meta property="article:modified_time" content="2021-08-27T12:49:06.000Z">
<meta property="article:author" content="naughtyrabbit">
<meta property="article:tag" content="阿里云">
<meta property="article:tag" content="MQTT协议">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://m1.im5i.com/2022/08/19/UcP6AG.jpg"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="https://naughtyrabbit.github.io/2021/08/27/AliIot_postTem/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于阿里云的智能温度计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-27 20:49:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="不听话的兔子君" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://e.im5i.com/2021/10/12/PEw4Y.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">不听话的兔子君</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">基于阿里云的智能温度计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-27T12:06:46.000Z" title="发表于 2021-08-27 20:06:46">2021-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-27T12:49:06.000Z" title="更新于 2021-08-27 20:49:06">2021-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%89%A9%E8%81%94%E7%BD%91/">物联网</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于阿里云的智能温度计"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><blockquote>
<p>本文详尽地描述了一个基于阿里云的智能温度计项目，功能是上报温度数据到阿里云的物联网平台，所有的代码都是“物联网零妖”这位大佬的，我改了一部分，此文旨在加以解释。如果觉得我说的不好，可以看他的原视频：<a target="_blank" rel="noopener" href="https://edu.aliyun.com/course/1492?spm=5176.10731491.0.0.ZXRrm4">https://edu.aliyun.com/course/1492?spm=5176.10731491.0.0.ZXRrm4</a></p>
</blockquote>
<span id="more"></span>
<h1>摘要</h1>
<p>  本系统利用51系列单片机为中心，通过ESP8266模块连接能上网的路由器，采集温湿度数据并上传阿里云，使用者可以使用手机APP或者在阿里云后台实时监控开发板所在环境温湿度。后续可以在云端对数据作分析并下发属性报文来控制其他设备对环境温度作调整，由于各种限制，本系统并未展开，目前仅可以上报温湿度数据，程序里写了相关的订阅报文，但是并没有实际设备执行。</p>
<h1>第一章 绪论</h1>
<p>  本系统主要功能是监测温湿度数据并上传阿里云。</p>
<h1>第二章 系统需求分析</h1>
<p>  本系统主要功能是监测温湿度数据并上传阿里云。细分一下，主要有以下需求：</p>
<ol>
<li>获取环境温湿度</li>
<li>连接能上网的路由器</li>
<li>连接阿里云的MQTT服务器并上传属性报文。</li>
</ol>
<h1>第三章 系统软硬件设计与实现</h1>
<p>  根据需求分析，这里也同样分三块作软硬件设计实现的说明：</p>
<h2 id="（一）获取环境温度">（一）获取环境温度</h2>
<h3 id="1-硬件选择及线路连接：">1.硬件选择及线路连接：</h3>
<p>  温湿度传感器采用DHT11：<br>
  单片机采用STC15W4K56S4，封装为LQFP48；<br>
  DHT11共四脚，VCC和GND不必多说，串行数据双向口SDA和单片机的IO口直连（26号管脚即P3.5/T1/T0CLKO/CCP0_2）；SCL口（串行时钟）悬空。</p>
<h3 id="2-软件部分程序编写">2.软件部分程序编写</h3>
<p>  相关代码为DHT11.c：<br>
  首先定义DHT11串行数据管脚SDA：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">DHT11_IO</span>	<span class="token expression">P35</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  下面是两个延时函数，不作展开</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Delay1us</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>		<span class="token comment">//@22.1184MHz</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>		<span class="token comment">//@22.1184MHz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  通过查询DHT11文档可知，DHT12 支持 I2C 方式进行通讯，完全按照 I2C 标准协议编制。<br>
<img src="https://e.im5i.com/2021/08/27/3vtvD.png" alt="dht12文档内容"><br>
  据此写以下函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//一个字节接收函数</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>dat<span class="token punctuation">;</span>
	dat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IO<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待DHT11拉低总线</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IO<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//等待DHT11拉高总线</span>
	<span class="token function">Delay1us</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dat<span class="token operator">=</span>dat<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>DHT11_IO<span class="token punctuation">)</span> 			<span class="token comment">//27us还是1则表示数据1</span>
		<span class="token punctuation">&#123;</span>
			dat<span class="token operator">=</span>dat<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> dat<span class="token punctuation">;</span>				<span class="token comment">//返回接收到的数据</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">Read_DHT11</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Check_Res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	
	<span class="token comment">//发送起始信号，通知DHT11准备数据</span>
	DHT11_IO <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DHT11_IO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IO<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待DHT11拉低总线</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IO<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待DHT11拉高总线</span>
	<span class="token comment">//开始接收数据</span>
	Humi_H <span class="token operator">=</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Humi_L <span class="token operator">=</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Temp_H <span class="token operator">=</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Temp_L <span class="token operator">=</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	CheckSum <span class="token operator">=</span> <span class="token function">recive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//接收DHT11输出的结束信号</span>
	<span class="token function">Delay1us</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//延迟后，将由DHT11拉高总线</span>
	Check_Res <span class="token operator">=</span> Humi_H<span class="token operator">+</span>Humi_L<span class="token operator">+</span>Temp_H<span class="token operator">+</span>Temp_L<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Check_Res <span class="token operator">!=</span> CheckSum<span class="token punctuation">)</span>	<span class="token comment">//作校验，数据有误直接返回</span>
	<span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">Read_DHT11_Str</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Temp<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Humi<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">//湿度两位数，温度一位小数</span>
	<span class="token function">Read_DHT11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//读取DHT11数据到全局变量</span>
	Humi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Humi_H<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
	Humi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Humi_H<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
	Humi<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Temp_L<span class="token operator">&amp;</span><span class="token number">0X80</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x80</span><span class="token punctuation">)</span>	 <span class="token comment">//温度低于0°</span>
	<span class="token punctuation">&#123;</span>
		Temp_L <span class="token operator">&amp;=</span> <span class="token number">0X7F</span><span class="token punctuation">;</span>
		Temp_L <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2D</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_H <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_H <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2E</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_L <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span>						<span class="token comment">//温度高于0°</span>
	<span class="token punctuation">&#123;</span>
		Temp_L <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2B</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_H <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_H <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x2E</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> Temp_L <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
		Temp<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="（二）连接能上网的路由器">（二）连接能上网的路由器</h2>
<h3 id="1-硬件选择及线路连接">1.硬件选择及线路连接</h3>
<p>  此部分与原理图中硬件选择有所不同，由于各种原因导致短时间内无法使用原定的EWM3080模块，转而使用ESP8266模块。二者在AT指令部分略有不同。对方案的实现没有大的差别。主要使用的管脚也都是：VCC,GND,RXD,TXD这四个。原来的所有关于EWM3080的部分也暂作保留，使用了新的串口及初始化函数来和ESP8266连接。</p>
<p>  如图，由于原理图中一开始引出了串口3，4以及VCC和GND作调试用，因此这里选择串口3与ESP8266连接。RXD3和ESO8266的TX连接，TXD3和ESP8266的RX连接。<br>
<img src="https://e.im5i.com/2021/08/27/3v1Yy.png" alt="dht12文档内容"><br>
  串口1和USB转串口模块连接，用来下载程序以及载入部分数据到flash</p>
<h3 id="2-软件部分程序编写-2">2.软件部分程序编写</h3>
<p>  软件程序部分主要涉及到串口3的初始化，中断处理，数据收发等函数；串口1的初始化等；CLI逻辑（下文具体解释）；AT指令的发送</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Init_Uart2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">//串口3初始化</span>
<span class="token punctuation">&#123;</span>
	S3CON <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//8位数据,可变波特率</span>
	S3CON <span class="token operator">&amp;=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>		<span class="token comment">//串口3选择定时器2为波特率发生器</span>
	AUXR <span class="token operator">|=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>		<span class="token comment">//定时器2时钟为Fosc,即1T</span>
	T2L <span class="token operator">=</span> <span class="token number">0xD0</span><span class="token punctuation">;</span>		<span class="token comment">//设定定时初值</span>
	T2H <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>		<span class="token comment">//设定定时初值</span>
	AUXR <span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//启动定时器2</span>
	IE2 <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>    <span class="token comment">//中断使能</span>
	<span class="token function">Queue_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WIFI_Read_Buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  串口初始化主要由STC官方给的工具输入系统频率和波特率计算而来；<br>
<img src="https://e.im5i.com/2021/08/27/3vBVh.png" alt="dht12文档内容"><br>
  串口中断使能通过查阅单片机相关数据手册得知IE2寄存器的第四位是中断使能标志位，因此置IE2为0x08表示中断使能。<br>
数据收发等基本操作不作赘述。<br>
<img src="https://e.im5i.com/2021/08/27/3vuOX.png" alt="dht12文档内容"><br>
  下面主要说明连接路由器部分，之前提到了CLI逻辑，这是用上位机将一些会使用到的数据生成并载入到单片机的FLASH中，其中原理不再展开，与在程序中直接写数据效果一致。<br>
  之前我们已经将串口3和ESP8266的串口相连了，接下来就是通过串口发送AT指令给ESP8266让其连接到路由器，并且与阿里云服务器建立TCP连接，进入透传模式发送报文。<br>
  查询ESP8266指令集可知，大部分指令，如果ESP8266正确接收，就会返回一个“OK”，据此，我们写了如下代码来表示基础的发送AT指令，如果一定时间内没有收到返回的“OK”就重发。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//发送AT指令，等待回复的”OK”，否则会重发</span>
<span class="token keyword">void</span> <span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>Str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Loop_Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> ReSend_Count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">WIFI_Send_Str</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//通过串口发送指令，WIFI的串口和串口3直连</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>					<span class="token comment">//等待回复的OK</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Loop_Count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Loop_Count <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			ReSend_Count<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ReSend_Count <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
				Loop_Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n重发指令："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WIFI_Send_Str</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重发一遍</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">else</span>			<span class="token comment">//重发次数超过3，直接退出</span>
			<span class="token punctuation">&#123;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n发送失败："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>		<span class="token comment">//发送失败，退出</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Get_Byte_WIFI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dat<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//监测接收缓冲区是否是OK</span>
		<span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>Dat <span class="token operator">==</span> <span class="token char">'O'</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
				<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">Get_Byte_WIFI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dat<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>Dat <span class="token operator">==</span> <span class="token char">'K'</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#123;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n成功执行一条指令"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>	
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  下面两个函数不是本系统重点，不作展开</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//拼接两条字符串，把2添加到1的后面</span>
<span class="token keyword">void</span> <span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str1<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str2<span class="token punctuation">)</span>
<span class="token comment">//拼接两条字符串，把2添加到1的钱前面</span>
<span class="token keyword">void</span> <span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str1<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>  下面的函数是建立TCP连接并进入透传模式，接下来所有发给串口3的数据将不会当作指令而是直接转给服务器。即下一步的发送报文步骤。也是参考AT指令集来写的：<br>
<img src="https://e.im5i.com/2021/08/27/3v4Df.png" alt="dht12文档内容"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//建立TCP连接，并进入透传模式 </span>
<span class="token keyword">void</span> <span class="token function">WiFi_Connect_Server</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataBuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>MQTT_URL_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">",1883,360\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在后面加上</span>
	<span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"AT+CIPSTART=\"TCP\","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在前面加上</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//AT指令发出去</span>
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  prepareto get in transparent transmission \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT+CIPSEND\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//AT指令发出去</span>
<span class="token punctuation">&#125;</span>
```   
<span class="token operator">&amp;</span>ensp<span class="token punctuation">;</span><span class="token operator">&amp;</span>ensp<span class="token punctuation">;</span>下面是WIFI的初始化，一直到连接上路由器。由于程序最后会让模块进入透传模式，因此一开始要输入“<span class="token operator">++</span><span class="token operator">+</span>”退出透传模式。
下面要连接路由器，需要WIFI的SSID和密码，这些应该是要提前在上位机中写入FLASH，如果没有写（即内容是<span class="token number">00</span>或者FF）则执行CLI逻辑，写入相关数据。  
``` c
<span class="token comment">//初始化WIFI包括设置SSID等参数</span>
<span class="token keyword">void</span> <span class="token function">Init_WIFI</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataBuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataBuf2<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//给WIFI密码用</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">//退出透传模式</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"+++"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//set station mode</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT+CWMODE=1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
	<span class="token comment">//查看FLASH内容，WIFI的SSID等内容，如果是00或者FF</span>
<span class="token comment">//表示是第一次开机，要执行CLI逻辑写入数据</span>
	DataLen <span class="token operator">=</span> <span class="token function">Read_One_Byte</span><span class="token punctuation">(</span>SSID_Addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	DataLen <span class="token operator">&lt;&lt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>
	DataLen <span class="token operator">+=</span> <span class="token function">Read_One_Byte</span><span class="token punctuation">(</span>SSID_Addr<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DataLen <span class="token operator">==</span> <span class="token number">0XFFFF</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>DataLen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  设备第一次开机，请进行设置 \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">CLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行CLI逻辑</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">/*
//调试用，重写WIFI的SSID，MQTT域名即报文等数据
	//please reload dat
		Send_Str1("\r\n reload data \r\n");
		while(1)
		&#123;
			CLI();//Ö´ÐÐCLIÂß¼­
		&#125;
	*/</span>
	<span class="token comment">//连接WIFI到路由器，station模式</span>
	<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>SSID_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>WIFI_Pass_Addr<span class="token punctuation">,</span>DataBuf2<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"AT+CWJAP="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Header</span><span class="token punctuation">(</span>DataBuf2<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf2<span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span>DataBuf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Sum_Str_Tail</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  prepare to get IP address \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT+CIFSR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  prepare to close transparent transsion \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT+CIPMODE=1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  prepare to close multiple link \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"AT+CIPMUX=0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  prepare to Open feedback \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_AT</span><span class="token punctuation">(</span><span class="token string">"ATE1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//Clear_WIFI();</span>
	
	<span class="token comment">//建立TCP连接，并进入透传模式</span>
	<span class="token function">WiFi_Connect_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="（三）连接阿里云的MQTT服务器并上传属性报文">（三）连接阿里云的MQTT服务器并上传属性报文</h2>
<h3 id="1-MQTT域名生成即报文说明：">1.MQTT域名生成即报文说明：</h3>
<p>  这部分没有硬件的操作，和之前一样是WIFI模块的工作。需要提前做好的工作是把MQTT域名，ClientID，用户名，密码，属性上报以及下发属性的报文等写入FALSH。<br>
<img src="https://e.im5i.com/2021/08/27/3vAkM.png" alt="dht12文档内容"></p>
<p>  首先应该现在阿里云平台创建产品，未产品添加设备，获取设备的三元组信息，即图中：<br>
ProductKey；DeviceName；DeviceSecret<br>
<img src="https://e.im5i.com/2021/08/27/3vIJ3.png" alt="dht12文档内容"></p>
<p>  这是阿里云平台的MQTT协议产品文档，可知采用的是一机一密、一型一密预注册认证方式：使用设备证书（ProductKey、DeviceName和DeviceSecret）连接。根据如上规则生成预定的connect报文等，此时服务器就会知道是我的设备而不是其他设备，程序里已经提前把connect报文写在FLASH中，在程序中读取并发给WIFI的串口，因为之前已经进入与服务器建立了TCP连接并进入了透传模式，现在发送connect报文就会顺利与阿里云服务器建立mqtt连接，此时，如果连接成功就会返回20 02的报文表示已经建立连接，程序的编写逻辑也是如此。此外，mqtt也有心跳机制，如果长时间不发送心跳包（c0 00的报文），服务器就会与客户端断开连接。因此在程序里面也需要写一个函数上传心跳包以保活。<br>
  最后是属性上报的报文，这一部分报文只有数据部分不同：比如下图是阿里云后台日志：<br>
<img src="https://e.im5i.com/2021/08/27/3vXA7.png" alt="dht12文档内容"></p>
<p>  属性上报报文上传的时候也就是上传这一部分，我们将其翻译成Hex如下：<br>
<img src="https://e.im5i.com/2021/08/27/3vHEp.png" alt="dht12文档内容"></p>
<p>  黄色的是数据，我们在程序中就是要把这一部分替换成实际的数据，而其他报文部分保留。</p>
<h3 id="2-软件部分程序编写：">2.软件部分程序编写：</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//发送connect报文，并等待服务器返回代码</span>
<span class="token keyword">void</span> <span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataBuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//先发送断开连接，防止上次连接还在线</span>
	<span class="token comment">/*
	for(i=0;i&lt;2;i++)
	&#123;
		WIFI_Send_Byte(MQTT_DisConnect[i]);
		//Delay1ms(1000);
		Send_Str1("\r\n now is sending disconnect command\r\n");
	&#125;
	*/</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Clear_WIFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//清空WIFI接受区，因为接下来要去接受区监测是否收到服务器的连接成功报文</span>
	
	<span class="token comment">//链接MQTT服务器</span>
	<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>MQTT_Connect_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取链接报文</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>DataLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//等待服务器返回</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Dat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">Get_Byte_WIFI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DataBuf<span class="token punctuation">[</span>Dat<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取缓冲区数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X20</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  链接MQTT服务器成功 \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		LED3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//发送一个心跳保活（非必要，只是保险）</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0x0c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  链接MQTT服务器失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>MQTT_Connect_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//读取MQTT报文</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>DataLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token comment">//订阅属性 服务器设置设备属性 用来接收服务器下发的消息</span>
	<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>MQTT_Sub_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取MQTT报文</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>DataLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token comment">//等待服务器返回</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">Get_Byte_WIFI</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DataBuf<span class="token punctuation">[</span>Dat<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取接收缓冲区数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X90</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0X03</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  订阅属性成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  订阅属性失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>DataLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//·发送心跳包 放到主循环中，定时器标志位到了就发送心跳</span>
<span class="token keyword">void</span> <span class="token function">Send_Heart</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> MQTT_Heart<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
	<span class="token keyword">if</span><span class="token punctuation">(</span>MQTT_Heart_Count <span class="token operator">></span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token comment">//10ms定时器里面会自动+1</span>
	<span class="token punctuation">&#123;</span>
		MQTT_Heart_Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>MQTT_Heart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>MQTT_Heart<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  ·发送一个心跳包到阿里云平台\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//定时上报温度数据</span>
<span class="token keyword">void</span> <span class="token function">Pub_Temperature</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DataBuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Temperature_DHT11<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放温度信息</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> Humi_DHT11<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放湿度信息</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>MQTT_PUB_Count <span class="token operator">></span> <span class="token number">700</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		MQTT_PUB_Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		
		<span class="token function">Get_Temp</span><span class="token punctuation">(</span>Temperature<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Read_DHT11_Str</span><span class="token punctuation">(</span>Temperature_DHT11<span class="token punctuation">,</span>Humi_DHT11<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n ADC_Temp=£º"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Temperature<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">" DHT11_Temp=£º"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Temperature_DHT11<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">" DHT11_Humi=£º"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span>Humi_DHT11<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">" \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		LED4 <span class="token operator">=</span> <span class="token operator">~</span>LED4<span class="token punctuation">;</span>
		
		<span class="token function">Read_Flash_Message</span><span class="token punctuation">(</span>MQTT_Post_Addr<span class="token punctuation">,</span>DataBuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>DataLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//属性上报报文</span>
		<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">" \r\n be ready to pay attention \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">132</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token comment">//·发送前132个报文，下面4个字节是实际的数据，要去替换</span>
<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//发送4个字节世界温度</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>Temperature_DHT11<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">//·发送12个自己固定部分报文</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//再发送12个字节</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">136</span><span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//·再发送2个字节的实际湿度报文</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>Humi_DHT11<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		<span class="token comment">//·发送剩下的报文</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>DataLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">WIFI_Send_Byte</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="（四）程序整体逻辑">（四）程序整体逻辑</h2>
<p>  下面过一遍main函数的逻辑：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">Init_IO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化IO口，LED等</span>
	<span class="token function">Init_Uart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//115200 初始化串口1</span>
	<span class="token function">Init_Uart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//115200 初始化串口2（实际用的是3，函数里面也是按3写的）</span>
	<span class="token function">Init_Timer1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//´打开定时器1，10ms定时器，发送心跳包等计时用</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">//´打开单片机全局中断</span>
	<span class="token function">Delay1ms</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  Hello This is ZengHui! \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  ALi-IOT LP Demo Based On 51-MCU. \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_Str1</span><span class="token punctuation">(</span><span class="token string">"\r\n  CLI Starting... \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Send_Str2</span><span class="token punctuation">(</span><span class="token string">"\r\n  ALi-IOT LP Demo Based On 51-MCU. \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Init_WIFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//WIFI模块初始化，一直到建立TCP链接</span>
	<span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//链接MQTT服务器</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">Send_Heart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送心跳包</span>
		<span class="token function">Pub_Temperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定时上报温度数据</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>第四章 系统调试与测试</h1>
<h2 id="（一）MQTT报文的准确性">（一）MQTT报文的准确性</h2>
<p>  首先应该测试MQTT报文的准确性，这里用MQTTfx这个软件模拟设备去链接阿里云的服务器，发送相关属性上报的报文，或者在阿里云调试端下发相关属性下发，都能正常收到；</p>
<h2 id="（二）本地温湿度数据的正确接收">（二）本地温湿度数据的正确接收</h2>
<pre class="line-numbers language-none"><code class="language-none">ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;??25.6 DHT11_Humi&#x3D;：65 
be ready to pay attention 
ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;：+25.6 DHT11_Humi&#x3D;：65 
be ready to pay attention 
ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;??25.6 DHT11_Humi&#x3D;：65 
be ready to pay attention 
ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;：+25.6 DHT11_Humi&#x3D;：65 
be ready to pay attention 
ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;：+25.7 DHT11_Humi&#x3D;：65 
be ready to pay attention 
ADC_Temp&#x3D;：-50.0 DHT11_Temp&#x3D;：+25.7 DHT11_Humi&#x3D;：64 
be ready to pay attention <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  以上是串口1的反馈，可以看到除了部分扰动的数据，其他数据（DHT11的）均正常</p>
<h2 id="（三）路由器的正常连接">（三）路由器的正常连接</h2>
<p>  路由器我是用手机热点来代替的，以下是串口反馈：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">AT<span class="token operator">+</span>CWJAP<span class="token operator">=</span><span class="token string">"rabbit"</span><span class="token punctuation">,</span><span class="token string">"88488848"</span>
成功执行一条指令<span class="token operator">:</span> AT<span class="token operator">+</span>CWJAP<span class="token operator">=</span><span class="token string">"rabbit"</span><span class="token punctuation">,</span><span class="token string">"88488848"</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  此时我的手机上也会有连接设备8266。</p>
<h2 id="（四）阿里云服务器连接。">（四）阿里云服务器连接。</h2>
<p>  这个部分失败了很多次，表现为连上但是只有一瞬间，查看阿里云日志发现只有online和offline的日志，且下线是非正常下线，错误码1911，不是1910，1910是由于心跳保活机制，1911是TCP链接断开。一般情况下1910才是更容易出现的错误。然后我手动另外接了一个串口与WIFI的串口直连，手动发送数据，发现没有问题，可以正常连接阿里云的物联网服务器，发送心跳包C0 00也可以收到回复D0 00。因此判定程序逻辑没有问题，后经过排查，发现有两个问题，一是我一开始在MQTT链接函数里一开始会发送E0 00去断开之前可能存在的链接，但是似乎一般情况下不去断开也没关系，反而断开会导致与TCP链接的断开。另一个问题我是发目标服务器换成本机，在本机上用网络调试助手建立一个TCP的服务器，连接之后发现程序跑的时候实际发送的报文会和预想的不一样，因此又作调整。最终链接成功。如下图，在阿里云物联网平台可以看到设备在线，并且在物模型中可以看到实时的数据以及记录。</p>
<p><img src="https://e.im5i.com/2021/08/27/3vP2v.png" alt="图片描述"><br>
<img src="https://e.im5i.com/2021/08/27/31DvG.png" alt="图片描述"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">naughtyrabbit</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://naughtyrabbit.github.io/2021/08/27/AliIot_postTem/">https://naughtyrabbit.github.io/2021/08/27/AliIot_postTem/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://naughtyrabbit.github.io" target="_blank">不听话的兔子君</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/">阿里云</a><a class="post-meta__tags" href="/tags/MQTT%E5%8D%8F%E8%AE%AE/">MQTT协议</a></div><div class="post_share"><div class="social-share" data-image="https://m1.im5i.com/2022/08/19/UcP6AG.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/11/12/pytorch_learning_grad/"><img class="prev-cover" src="https://m1.im5i.com/2022/08/19/UcP3AA.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">pytorch学习笔记-回归问题</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/22/ComStruc_Encoding/"><img class="next-cover" src="https://m1.im5i.com/2022/08/18/UcH3bX.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">计算机组织与体系结构——补码与模与浮点数的规格化</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://e.im5i.com/2021/10/12/PEw4Y.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">naughtyrabbit</div><div class="author-info__description">记录生活，记录成长</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">86</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/naughtyrabbit"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/naughtyrabbit" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">第一章 绪论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">第二章 系统需求分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">第三章 系统软硬件设计与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E6%B8%A9%E5%BA%A6"><span class="toc-number">4.1.</span> <span class="toc-text">（一）获取环境温度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6%E9%80%89%E6%8B%A9%E5%8F%8A%E7%BA%BF%E8%B7%AF%E8%BF%9E%E6%8E%A5%EF%BC%9A"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.硬件选择及线路连接：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BD%AF%E4%BB%B6%E9%83%A8%E5%88%86%E7%A8%8B%E5%BA%8F%E7%BC%96%E5%86%99"><span class="toc-number">4.1.2.</span> <span class="toc-text">2.软件部分程序编写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E8%BF%9E%E6%8E%A5%E8%83%BD%E4%B8%8A%E7%BD%91%E7%9A%84%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="toc-number">4.2.</span> <span class="toc-text">（二）连接能上网的路由器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6%E9%80%89%E6%8B%A9%E5%8F%8A%E7%BA%BF%E8%B7%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.硬件选择及线路连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BD%AF%E4%BB%B6%E9%83%A8%E5%88%86%E7%A8%8B%E5%BA%8F%E7%BC%96%E5%86%99-2"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.软件部分程序编写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E8%BF%9E%E6%8E%A5%E9%98%BF%E9%87%8C%E4%BA%91%E7%9A%84MQTT%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%B1%9E%E6%80%A7%E6%8A%A5%E6%96%87"><span class="toc-number">4.3.</span> <span class="toc-text">（三）连接阿里云的MQTT服务器并上传属性报文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-MQTT%E5%9F%9F%E5%90%8D%E7%94%9F%E6%88%90%E5%8D%B3%E6%8A%A5%E6%96%87%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="toc-number">4.3.1.</span> <span class="toc-text">1.MQTT域名生成即报文说明：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BD%AF%E4%BB%B6%E9%83%A8%E5%88%86%E7%A8%8B%E5%BA%8F%E7%BC%96%E5%86%99%EF%BC%9A"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.软件部分程序编写：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E7%A8%8B%E5%BA%8F%E6%95%B4%E4%BD%93%E9%80%BB%E8%BE%91"><span class="toc-number">4.4.</span> <span class="toc-text">（四）程序整体逻辑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">第四章 系统调试与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89MQTT%E6%8A%A5%E6%96%87%E7%9A%84%E5%87%86%E7%A1%AE%E6%80%A7"><span class="toc-number">5.1.</span> <span class="toc-text">（一）MQTT报文的准确性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E6%9C%AC%E5%9C%B0%E6%B8%A9%E6%B9%BF%E5%BA%A6%E6%95%B0%E6%8D%AE%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%8E%A5%E6%94%B6"><span class="toc-number">5.2.</span> <span class="toc-text">（二）本地温湿度数据的正确接收</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E6%AD%A3%E5%B8%B8%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.3.</span> <span class="toc-text">（三）路由器的正常连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9E%E6%8E%A5%E3%80%82"><span class="toc-number">5.4.</span> <span class="toc-text">（四）阿里云服务器连接。</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/private-diary-1/" title="个人随笔-意识流日记-2022.11.6"><img src="https://m1.im5i.com/2022/08/19/UcPHgz.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="个人随笔-意识流日记-2022.11.6"/></a><div class="content"><a class="title" href="/2022/11/06/private-diary-1/" title="个人随笔-意识流日记-2022.11.6">个人随笔-意识流日记-2022.11.6</a><time datetime="2022-11-06T11:49:08.000Z" title="发表于 2022-11-06 19:49:08">2022-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/02/linux-myshell/" title="用fork,exec,wait实现一个自己的shell"><img src="https://m1.im5i.com/2022/08/17/UcovSH.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用fork,exec,wait实现一个自己的shell"/></a><div class="content"><a class="title" href="/2022/11/02/linux-myshell/" title="用fork,exec,wait实现一个自己的shell">用fork,exec,wait实现一个自己的shell</a><time datetime="2022-11-02T01:06:35.000Z" title="发表于 2022-11-02 09:06:35">2022-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/24/FPGA-SEM-intro/" title="FPGA_软错误缓解_介绍"><img src="https://m1.im5i.com/2022/08/19/UcPlkp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="FPGA_软错误缓解_介绍"/></a><div class="content"><a class="title" href="/2022/08/24/FPGA-SEM-intro/" title="FPGA_软错误缓解_介绍">FPGA_软错误缓解_介绍</a><time datetime="2022-08-24T08:51:07.000Z" title="发表于 2022-08-24 16:51:07">2022-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/23/FPGA-DFX-RTLprj/" title="FPGA_动态功能切换_DFX RTL工程流程"><img src="https://m1.im5i.com/2022/08/19/UcPRvF.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="FPGA_动态功能切换_DFX RTL工程流程"/></a><div class="content"><a class="title" href="/2022/08/23/FPGA-DFX-RTLprj/" title="FPGA_动态功能切换_DFX RTL工程流程">FPGA_动态功能切换_DFX RTL工程流程</a><time datetime="2022-08-23T01:37:15.000Z" title="发表于 2022-08-23 09:37:15">2022-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/22/private-blog-1/" title="私人日记-1"><img src="https://m1.im5i.com/2022/08/19/UcPEhT.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="私人日记-1"/></a><div class="content"><a class="title" href="/2022/08/22/private-blog-1/" title="私人日记-1">私人日记-1</a><time datetime="2022-08-22T14:26:24.000Z" title="发表于 2022-08-22 22:26:24">2022-08-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By naughtyrabbit</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>